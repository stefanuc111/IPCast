$(document).ready(init);var i=0,downloaded=[],time,sendingFiles=!1,display_data,display_data_type,auto_download,fading;
function sendFiles(){fading=!0;$("#progressBar").fadeIn(400,function(){fading=!1});var a=new FormData;a.append("action","ajax_handler_import");for(var b=$("#fileInput")[0].files,c=0;c<b.length;c++)a.append("file_"+c,b[c]);sendingFiles=!0;$.ajax({url:"send_files",data:a,processData:!1,contentType:!1,type:"POST",success:function(a){$("#progressBar").fadeOut(400,function(){$("#progressBar").css("width","0%");$("#fileButton").fadeIn()});sendingFiles=!1}})}
var myPlayer,startseek,seekingtime=0,context,ws;
function init(a){(a=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext)&&(context=new a);window.performance&&(performance_now=!0);"function"==typeof WebSocket?connectWebSocket():loadData();$("#audio_buttonPlay").click(enableAudio);Modernizr.input.multiple?$("#fileInput").attr("multiple","multiple"):alert("Multi upload not supported!");$("#image_viewer").load(show);videojs("video_viewer").ready(function(){myPlayer=this;videojsLoaded=
!0;null!=display_data&&"video"==display_data_type&&(mPlayer.src("/"+display_data),mPlayer.load(),myPlayer.play());myPlayer.M.onseeking=function(){startseek=(new Date).getTime()};myPlayer.M.onseeked=function(){seekingtime=(new Date).getTime()-startseek}});$("#fileInput").change(function(){0<$("#fileInput")[0].files.length&&$("#fileButton").fadeOut(400,sendFiles)})}
function connectWebSocket(){var a=window.location.port;a++;ws=new WebSocket("ws://"+window.location.hostname+":"+a);null!=ws&&(ws.onopen=WebSocketOpen,ws.onmessage=WebSocketMessage,ws.onerror=WebSocketError,ws.onclose=WebSocketClose)}function show(){$("#image_viewer").fadeIn("slow",function(){blur_background();$("#circularG").hide()})}var syncronizing=!1,starttime=null;
function loadData(){starttime=getTimer();$.getJSON("api.json",function(a){auto_download=a.auto_download;sound_beam=a.SoundBeam;updateFileList(a.files);a.downloaded&&sendingFiles&&progressHandlingFunction(a.downloaded);if(void 0!=a.display_data)if(!sound_beam||"audio"!=a.display_data_type&&"video"!=a.display_data_type?(hideSupportedB(),setCurrentData(a.display_data,a.display_data_type)):showSupportedB(),a.isPlaying){0!=RecivedTimes.length&&0.5<Math.abs(getTime()-a.CurrentTime/1E3)&&clearTime();var b=
getTimer();setTime(a.CurrentTime/1E3+(b-starttime)/2);starttime=null;"video"==display_data_type&&updateVideoPlayer();"audio"==display_data_type&&updateAudioPlayer()}else pauseVideoPlayer(),pauseAudioPlayer();else hideSupportedB(),null!=display_data&&closeAllPlayers();("audio"==display_data_type||"video"==display_data_type)&&50>RecivedTimes.length?setTimeout("loadData();",50):setTimeout("loadData();",500)})}var show_supported=!1;
function showSupportedB(){show_supported||($("#icons").show(),$("#overlay").show());show_supported=!0}function hideSupportedB(){show_supported&&($("#icons").hide(),$("#overlay").hide());show_supported=!1}function showImage(a){$("#image_viewer").attr("src",a);$("#circularG").show()}function closeImageViewer(){$("#image_viewer").fadeOut();$("#circularG").hide()}function closeVideoPlayer(){pauseVideoPlayer();$("#video_viewer").fadeOut()}
function closeAllPlayers(){closeVideoPlayer();closeAudioPlayer();closeImageViewer();unblur_background();$("#overlay").fadeOut();display_data_type=display_data=null}function pauseAudioPlayer(){stopTimeSync();null!=audio_update_interval&&clearInterval(audio_update_interval);audio_update_interval=null;null!=source&&(source.disconnect(),source.stop(0),source=null);null!=next_chunkSource&&(next_chunkSource.disconnect(),next_chunkSource.stop(0),next_chunkSource=null)}
function closeAudioPlayer(){clearTime();pauseAudioPlayer();$("#circularG").hide();$("#audio_buttonPlay").fadeOut()}function loadVideoSrc(a){null!=myPlayer&&(pauseVideoPlayer(),myPlayer.src(a),myPlayer.load());$("#video_viewer").fadeIn("slow",function(){blur_background()})}function blur_background(){debugM||$("#realBody").addClass("blur")}function unblur_background(){$("#realBody").removeClass("blur")}var sound_beam=!1;
function updateVideoPlayer(){var a;null!=myPlayer&&(a=myPlayer.M);var b=myPlayer.currentTime()-getTime();null!=a&&4==a.readyState?(a.paused&&myPlayer.play(),Math.abs(b)>(sound_beam?0.5:3)||syncronizing?(syncronizing=!0,Math.abs(b)<=(sound_beam?0.15:1)?syncronizing=!1:myPlayer.M.seeking||(a=getTime()+seekingtime/1E3,isBuffered(a)&&myPlayer.currentTime(a))):sound_beam&&(a=1-0.5*b,1.1<a&&(a=1.1),0.9>a&&(a=0.9),myPlayer.M.playbackRate=a),syncronizing?myPlayer.volume(0):myPlayer.volume(1)):myPlayer.pause()}
function isBuffered(a){var b=null;if(null!=myPlayer){for(var c=0;c<myPlayer.M.buffered.length;c++){var d=myPlayer.M.buffered.start(c),e=myPlayer.M.buffered.end(c);if(a>d&&a<e)return!0;(null==b||b>e-a)&&0<=e-a&&(b=e-a)}return null==b||4<=b?!0:!1}}var chunkbuffers=[];function buffer(){this.chunk_number=this.buffer=null}
function getBuffer(a,b){if(1E3*a*frame_duration<duration){for(var c=0;c<chunkbuffers.length;c++)if(chunkbuffers[c].chunk_number==a)return chunkbuffers[c].buffer;var d=new buffer;d.chunk_number=a;chunkbuffers.push(d);loadBuffer("/"+display_data+"_"+a,function(a){3<chunkbuffers.length&&chunkbuffers.splice(0,chunkbuffers.length-3);d.buffer=a},function(){removeBuffer(d)},b)}return!1}function removeBuffer(a){for(var b=0;b<chunkbuffers.length;b++)chunkbuffers[b]==a&&chunkbuffers.splice(b,1)}
var request,response;function loadBuffer(a,b,c,d){if(request)if(d)request.abort();else{c();return}request=new XMLHttpRequest;request.open("GET",a,!0);request.responseType="arraybuffer";request.onload=function(a){200==request.status?(response=request.response,context.decodeAudioData(request.response,b,function(){alert("decoding error!")})):c();request=null};request.onabort=c;request.onerror=c;request.send()}
function enableAudio(){null!=sourcebuffer&&(source=context.createBufferSource(),source.buffer=sourcebuffer,source.connect(context.destination),source.start(0))}function getChunkIndex(a){return a/(1E3*frame_duration)|0}var next_chunkSource=null,frame_duration=1152/44100,duration;
function updateAudioPlayer(){var a=null,b=getTime(),c=getBuffer(getChunkIndex(b),!0),d,e;if(c){a=context.createBufferSource();a.connect(context.destination);a.buffer=c;a.start(0,d=b-1E3*getChunkIndex(b)*frame_duration);e=getTimer();null!=next_chunkSource&&(0!=next_chunkSource.playbackState&&next_chunkSource.stop(0),next_chunkSource.disconnect(),next_chunkSource=null);if(b=getBuffer(getChunkIndex(b)+1,!1))next_chunkSource=context.createBufferSource(),next_chunkSource.buffer=b,next_chunkSource.connect(context.destination),
next_chunkSource.start(e+(c.duration-d),2*frame_duration);showPlay()}else unblur_background(),$("#audio_buttonPlay").fadeOut(),$("#circularG").show();null!=source&&(0!=source.playbackState&&source.stop(0),source.disconnect());source=a}var bufferedChunk,RecivedTimes=[],NextValuePosition=0;function getTime(){for(var a=0,b=0;b<RecivedTimes.length;b++)a+=RecivedTimes[b];return 0==RecivedTimes.length?0:a/RecivedTimes.length+getTimer()}var performance_now=!1;
function getTimer(){return"audio"==display_data_type?context.currentTime:performance_now?window.performance.now()/1E3:Date.now()/1E3}function setTime(a){RecivedTimes[NextValuePosition]=a-getTimer();49==NextValuePosition?NextValuePosition=0:NextValuePosition++}function clearTime(){RecivedTimes=[];NextValuePosition=0}function progressHandlingFunction(a){var b=Math.round(a/100*1E3);fading||$("#progressBar").stop(!0);$("#progressBar").animate({width:a+"%","background-position-x":b+"px"})}
var next_audio_file=null,file_name,extension,source=null,sourcebuffer=null,next_sourcebuffer=null,next_chunk_is_loading=!1;function showPlay(){$("#circularG").hide();$("#audio_buttonPlay").fadeIn("slow",function(){blur_background()})}function WebSocketOpen(){}
function WebSocketMessage(a){if("w"!=a.data)switch(a=JSON.parse(a.data),void 0!=a.CurrentTime&&setTime(a.CurrentTime),a.type){case "CurrentTime":var b;null==starttime?starttime=b=0:b=getTimer();RecivedTimes[RecivedTimes.length-1]!=a.value&&setTime(a.value/1E3+(b-starttime)/2);starttime=null;break;case "CurrentData":hideSupportedB();void 0!=a.data?(setCurrentData(a.data,a.data_type),void 0!=a.duration&&(duration=a.duration),void 0!=a.sample_rate&&(frame_duration=1152/a.sample_rate)):closeAllPlayers();
isPlaying&&"audio"==a.data_type&&playAudio();break;case "FileListChange":updateFileList(a.files);break;case "Seeked":clearTime();starttime=null;break;case "SettingsChanges":auto_download=a.AutoDownload;sound_beam=a.SoundBeam;a.Debug?debugMode():removeDebugMode();break;case "UploadedStatusChange":a.value&&progressHandlingFunction(a.value);break;case "PlayStatusChange":isPlaying=a.isPlaying,null!=display_data&&("video"==display_data_type?a.isPlaying?playVideo():pauseVideoPlayer():a.isPlaying?playAudio():
pauseAudioPlayer())}else console.log(a.data)}function WebSocketClose(){closeAllPlayers();setTimeout("connectWebSocket();",2E3)}function WebSocketError(){closeAllPlayers()}function pauseVideoPlayer(){stopTimeSync();null!=video_update_interval&&clearInterval(video_update_interval);video_update_interval=null;null!=myPlayer&&myPlayer.pause()}
function setCurrentData(a,b){display_data_type=b;display_data!=a&&(display_data=a,"image"==display_data_type?(closeVideoPlayer(),closeAudioPlayer(),showImage("/"+display_data)):"video"==display_data_type?($("#circularG").hide(),closeAudioPlayer(),closeImageViewer(),loadVideoSrc("/"+display_data)):"audio"==display_data_type&&(chunkbuffers=[],closeVideoPlayer(),closeImageViewer(),closeAudioPlayer()),$("#overlay").fadeIn())}var video_update_interval=null,isPlaying=!1;
function playVideo(){myPlayer.M.oncanplay=null;null!=myPlayer&&null!=myPlayer.M&&(4==myPlayer.M.readyState?(myPlayer.play(),null==video_update_interval&&(video_update_interval=setInterval("updateVideoPlayer();",500)),startTimeSync()):myPlayer.M.oncanplay=playVideo)}var getTime_interval=null;function startTimeSync(){null==getTime_interval&&(getTime_interval=setInterval("requestNewTime();",50))}function requestNewTime(){null==starttime&&(starttime=getTimer(),ws.send("getCurrentTime"))}
function stopTimeSync(){null!=getTime_interval&&clearTimeout(getTime_interval);getTime_interval=starttime=null}var audio_update_interval=null;function playAudio(){void 0!=context?null==audio_update_interval&&(startTimeSync(),updateAudioPlayer(),audio_update_interval=setInterval("updateAudioPlayer();",500)):showSupportedB()}
function updateFileList(a){$("#main").html("");for(var b=0;b<a.length;b++)$("#main").append("<div class='filerow' href='/"+a[b].hash+"'><div class='fileicon'></div><div class='link'>"+a[b].name+" - "+lang_string.download_now+"</div></div>"),!0!=downloaded[a[b].hash+""]&&auto_download&&(setTimeout('downloadURL("/'+a[b].hash+'");',500+500*b),downloaded[a[b].hash+""]=!0);0==a.length&&$("#main").html("<p id='noFile'>"+lang_string.no_files+"</p>");$(".filerow").click(function(){var a=$(this).attr("href");
downloadURL(a)})}function downloadURL(a){var b=document.getElementById("hiddenDownloader");null===b&&(b=document.createElement("iframe"),b.id="hiddenDownloader",b.style.display="none",document.body.appendChild(b));b.src=a}var debugM=!1,debug_interval=null;function debugMode(){debugM=!0;$("body").append("<div id='time'></div> </ br><div id='ping'></div>");debug_interval=setInterval("$('#time').html(Math.floor(getTime()*1000))",30);$("#time").css("font-size","100px");unblur_background()}
function removeDebugMode(){debugM=!1;null!=debug_interval&&clearInterval(debug_interval);$("#ping").remove();$("#time").remove()};

